library(fusionData)
library(haven)
library(data.table)
library(ggplot2)
library(naniar)
library(mice)
library(survey)
library(labelled)
library(tidyverse)
source("R/utils.R")
source("R/createDictionary.R")
source("R/imputeMissing.R")
source("R/detectDependence.R")
#getSurveyProcessed(survey = "all")

in_dir <- 'C:/Users/ncgra/Dropbox/Penn/repos/acs_wrapper/rhfs/'
out_dir <- 'C:/Users/ncgra/Dropbox/Penn/repos/acs_wrapper/rhfs/'
plot_dir <- 'C:/Users/ncgra/Dropbox/Eviction Lab/project ideas/rent_exploitation/plots'

rhfs12 <- readRDS(paste0(out_dir,'clean_RHFS_2012.RDS'))
rhfs18 <- readRDS(paste0(out_dir,'clean_RHFS_2018.RDS'))

## Drop where rent exploitation > 1 (some outliers because of massive rents collected by pretty small reported market values... I wonder if there are repeat values by building. Check later.)
#rhfs12 <- rhfs12[rent_exploitation<=1, ]
#rhfs18 <- rhfs18[rent_exploitation<=1, ]

## Factors
rhfs18[, units_total_cat := factor(units_total_cat, levels=c("1 unit","2-4 units","5-24 units","25-49 units","50+ units"))]

## Groups
rhfs18[, cash_down_prop := cash_down / purchase_price]
rhfs18[, cash_down_prop := ifelse(cash_down_prop>1,1,cash_down_prop)]
rhfs18[year_acquired %in% c('2010-2012','2013-2015','2016-2018'), year_acquired_cat := 'Post-2010']
rhfs18[year_acquired %in% c('1990-1999','2000-2004','2005-2009'), year_acquired_cat := '1990-2009']
rhfs18[year_acquired %in% c('Earlier than 1969','1970-1979','1980-1989'), year_acquired_cat := 'Pre-1990']
rhfs18[, year_acquired_cat := factor(year_acquired_cat,levels=c('Pre-1990','1990-2009','Post-2010'))]
rhfs18[cash_down_prop==0, cash_down_cat := '0%']
rhfs18[cash_down_prop>0 & cash_down_prop<0.25, cash_down_cat := '1-24%']
rhfs18[cash_down_prop>=0.25 & cash_down_prop<0.8, cash_down_cat := '25-79%']
rhfs18[cash_down_prop>=0.8, cash_down_cat := '>80%']
rhfs18[, cash_down_cat := factor(cash_down_cat,levels=c('0%','1-24%','25-79%','>80%'))]

## Grab survey-weighted medians by ownership in both years
calc_svymetric <- function(des, svyvar='rent_exploitation', byvar='ownership', metric='median') {
  if(metric=='median') medians.svy <- svyby(as.formula(paste0('~',svyvar)), as.formula(paste0('~',byvar)), des, svyquantile, quantiles=0.5, keep.var=FALSE, ci=T, interval.type="Wald")
  if(metric=='mean') medians.svy <- svyby(as.formula(paste0('~',svyvar)), as.formula(paste0('~',byvar)), des, svymean, keep.var=FALSE, ci=T, interval.type="Wald")
  medians <- as.data.table(medians.svy)
  medians[, lower := tstrsplit(`statistic.CIs`,',',keep=1)]
  medians[, lower := as.numeric(gsub('c[(]','',lower))]
  medians[, upper := tstrsplit(`statistic.CIs`,',',keep=2)]
  medians[, upper := as.numeric(gsub('[)]','',upper))]
  medians[, median := as.numeric(medians.svy$statistic.quantiles)]
  medians <- medians[,c(unlist(str_split(byvar,'[+]')),'median','lower','upper'),with=F]
  return(medians)
}
## Collapse more granular 2012 groups
reclassify_owner <- function(d) {
  d[ownership %in% c('LLC','LLP'), ownership := 'LLC']
  d[ownership %in% c('Real estate corporation','REIT'), ownership := 'Corporation/REIT']
  d[ownership %in% c('individual'), ownership := 'Individual']
  d[!(ownership %in% c('LLC','Corporation/REIT','Individual')), ownership := 'Other']
}
reclassify_owner(rhfs12)
reclassify_owner(rhfs18)
# des <- svydesign(id=~rhfs_2012_hid, weights=~weight, data=rhfs12[!is.na(rent_exploitation),])
# medians12 <- calc_medians(des)
# medians12[, year := 2012]
# des <- svydesign(id=~rhfs_2018_hid, weights=~weight, data=rhfs18[!is.na(rent_exploitation),])
# medians18 <- calc_medians(des)
# medians18[, year := 2018]
# medians <- rbind(medians12,medians18)
# medians[, year := as.factor(year)]
# ggplot(data=medians[ownership %in% c('Individual','LLC','Corporation/REIT')]) + 
#   geom_linerange(aes(x=year,
#                      ymin=lower,
#                      ymax=upper,
#                      color=ownership,
#                      group=ownership),
#                  size=1, color='black', position=position_dodge(width=.2)) +
#   geom_point(aes(x=year,
#                  y=median,
#                  fill=ownership,
#                  group=ownership),
#              shape=21,
#              size=6, stroke=1.5, position=position_dodge(width=.2)) + 
#   labs(y=paste0('Rent exploitation'),x='',fill='Ownership entity') +
#   guides(color=F) + 
#   #coord_flip() +
#   scale_fill_viridis_d() + 
#   theme_minimal() +
#   theme(strip.text.x = element_text(size = 12),
#         axis.title.y = element_text(size = 12, margin = margin(r=10)),
#         axis.title.x = element_text(size = 12, margin = margin(t=10)),
#         axis.text = element_text(size = 12),
#         legend.title = element_text(size = 12),
#         legend.text = element_text(size = 12))

## Examine by levels of rent
rhfs12[, monthly_rent_housing_unit := total_rent_collected/units_total_topcode/12]
rhfs12[, rent_group := ifelse(monthly_rent_housing_unit<800,'Under $800','$800 or more')]
rhfs18[, rent_group := ifelse(monthly_rent_housing_unit<800,'Under $800','$800 or more')]
# des <- svydesign(id=~rhfs_2012_hid, weights=~weight, data=rhfs12[!is.na(rent_exploitation),])
# medians12 <- calc_medians(des, byvar='rent_group')
# medians12[, year := 2012]
# des <- svydesign(id=~rhfs_2018_hid, weights=~weight, data=rhfs18[!is.na(rent_exploitation),])
# medians18 <- calc_medians(des, byvar='rent_group')
# medians18[, year := 2018]
# medians <- rbind(medians12,medians18)
# medians[, year := as.factor(year)]
# #png(paste0(out_dir,'/rent_exploitation_2012_2018.png'), res=600, units='in', height=8, width=11)
# ggplot(data=medians) + 
#   geom_linerange(aes(x=year,
#                      ymin=lower,
#                      ymax=upper,
#                      color=rent_group,
#                      group=rent_group),
#                  size=1, color='black', position=position_dodge(width=.2)) +
#   geom_point(aes(x=year,
#                  y=median,
#                  fill=rent_group,
#                  group=rent_group),
#              shape=21,
#              size=6, stroke=1.5, position=position_dodge(width=.2)) + 
#   labs(y=paste0('Median rent exploitation (rent / market value)'),x='',fill='Average monthly rent per unit') +
#   guides(color=F) + 
#   #coord_flip() +
#   scale_fill_viridis_d() + 
#   theme_minimal() +
#   theme(strip.text.x = element_text(size = 18),
#         axis.title.y = element_text(size = 18, margin = margin(r=10)),
#         axis.title.x = element_text(size = 18, margin = margin(t=10)),
#         axis.text = element_text(size = 18),
#         legend.title = element_text(size = 18),
#         legend.text = element_text(size = 18))
#dev.off()

## Composition of ownership
# options(scipen=999)
# rhfs18[, mortgage_string := ifelse(mortgage==1,'Yes','No')]
# des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(ownership) & !is.na(units_total_cat) & !is.na(rent_exploitation)])
# prop.table(svytable(~ownership, des))
# prop.table(svytable(~units_total_cat, des))
# calc_svymetric(des, byvar='ownership+units_total_cat')
# 
# ## Rent exploitation by ownership and size
# table(rhfs18[,c('ownership','units_total_cat')])
# medians <- calc_svymetric(des, byvar='units_total_cat+mortgage', metric='median')
# ggplot(data=medians) + 
#   geom_point(data=rhfs18,
#              aes(x=mortgage,
#                  y=rent_exploitation,
#                  fill=units_total_cat,
#                  group=units_total_cat),
#              shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.4)) + 
#   geom_linerange(aes(x=mortgage,
#                      ymin=lower,
#                      ymax=upper,
#                      color=units_total_cat,
#                      group=units_total_cat),
#                  size=1, color='black', position=position_dodge(width=.4)) +
#   geom_point(aes(x=mortgage,
#                  y=median,
#                  fill=units_total_cat,
#                  group=units_total_cat),
#              shape=21,
#              size=6, stroke=1.5, position=position_dodge(width=.4)) + 
#   labs(y=paste0('Median rent exploitation (rent / market value)'),x='',fill='Average monthly rent per unit') +
#   guides(color=F) + 
#   scale_fill_viridis_d() + 
#   lims(y=c(0,0.5)) + 
#   theme_minimal() +
#   theme(strip.text.x = element_text(size = 18),
#         axis.title.y = element_text(size = 18, margin = margin(r=10)),
#         axis.title.x = element_text(size = 18, margin = margin(t=10)),
#         axis.text = element_text(size = 18),
#         legend.title = element_text(size = 18),
#         legend.text = element_text(size = 18))
# 
# ## Rent exploitation by rent group
# des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_group) & !is.na(units_total_cat) & !is.na(rent_exploitation)])
# svyglm(rent_exploitation~monthly_rent_housing_unit, des)
# 
# ## Profits by ownership OR size (samples too small)
# rhfs18[, keep := 1]
# rhfs18[ownership=='Corporation/REIT' & units_total_cat!='50+ units', keep := 0]
# rhfs18[ownership=='Other' & units_total_cat=='25-49 units', keep := 0]
# des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(ownership) & !is.na(units_total_cat) & !is.na(profit_unit_month_margin) & keep==1,])
# prop.table(svytable(~ownership+units_total_cat, des))
# medians <- calc_svymetric(des, svyvar='profit_unit_month_margin', byvar='ownership+units_total_cat', metric='median')
# ggplot(data=medians) + 
#   geom_hline(yintercept=0,linetype='dashed') + 
#   geom_point(data=rhfs18,
#              aes(x=units_total_cat,
#                  y=profit_unit_month_margin,
#                  fill=ownership,
#                  group=ownership),
#              shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.4)) + 
#   geom_linerange(aes(x=units_total_cat,
#                      ymin=lower,
#                      ymax=upper,
#                      color=ownership,
#                      group=ownership),
#                  size=1, color='black', position=position_dodge(width=.4)) +
#   geom_point(aes(x=units_total_cat,
#                  y=median,
#                  fill=ownership,
#                  group=ownership),
#              shape=21,
#              size=6, stroke=1.5, position=position_dodge(width=.4)) + 
#   labs(y=paste0('Median profit margin per unit, (rent/expenses)/rent'),x='',fill='Average monthly rent per unit') +
#   guides(color=F) + 
#   scale_fill_viridis_d() + 
#   lims(y=c(-1,1)) + 
#   theme_minimal() +
#   theme(strip.text.x = element_text(size = 18),
#         axis.title.y = element_text(size = 18, margin = margin(r=10)),
#         axis.title.x = element_text(size = 18, margin = margin(t=10)),
#         axis.text = element_text(size = 18),
#         legend.title = element_text(size = 18),
#         legend.text = element_text(size = 18))

## Examine by value decile
# rhfs18 <- rhfs18[, market_value_unit_decile := cut(market_value_unit, quantile(market_value_unit, probs=0:5/5), include.lowest=TRUE, labels=FALSE)]
# rhfs18[, market_value_unit_decile := factor(market_value_unit_decile,levels=1:5)]
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
national_quintiles <- svyquantile(~market_value_unit, des, quantiles=0:5/5, keep.var=FALSE, include.lowest=T, ci=T, interval.type="Wald")  
national_quintiles <- national_quintiles$quantiles
for(q in 6:2) rhfs18[market_value_unit<=national_quintiles[,q], market_value_unit_decile := q-1]
rhfs18[, market_value_unit_decile := factor(market_value_unit_decile, levels=1:5)]

rhfs12[, rent_exploitation := (monthly_rent_housing_unit*12) / market_value_unit]
des <- svydesign(id=~rhfs_2012_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs12[!is.na(rent_exploitation),])
national_quintiles <- svyquantile(~market_value_unit, des, quantiles=0:5/5, keep.var=FALSE, include.lowest=T, ci=T, interval.type="Wald")  
national_quintiles <- national_quintiles$quantiles
for(q in 6:2) rhfs12[market_value_unit<=national_quintiles[,q], market_value_unit_decile := q-1]
rhfs12[, market_value_unit_decile := factor(market_value_unit_decile, levels=1:5)]

des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
national_quintiles <- svyquantile(~market_value_unit, des, quantiles=0:10/10, keep.var=FALSE, include.lowest=T, ci=T, interval.type="Wald")  
national_quintiles <- national_quintiles$quantiles
for(q in 11:2) rhfs18[market_value_unit<=national_quintiles[,q], market_value_unit_decile2 := q-1]
rhfs18[, market_value_unit_decile2 := factor(market_value_unit_decile2, levels=1:10)]

des <- svydesign(id=~rhfs_2012_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs12[!is.na(rent_exploitation),])
national_quintiles <- svyquantile(~market_value_unit, des, quantiles=0:10/10, keep.var=FALSE, include.lowest=T, ci=T, interval.type="Wald")  
national_quintiles <- national_quintiles$quantiles
for(q in 11:2) rhfs12[market_value_unit<=national_quintiles[,q], market_value_unit_decile2 := q-1]
rhfs12[, market_value_unit_decile2 := factor(market_value_unit_decile2, levels=1:10)]

## COMPARE TRENDS 2012 and 2018
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
medians18 <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_unit_decile2', metric='median')
medians18[, upper := ifelse(upper<1,upper,1)]
medians18[, time := 2018]
des <- svydesign(id=~rhfs_2012_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs12[!is.na(rent_exploitation),])
medians12 <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_unit_decile2', metric='median')
medians12[, upper := ifelse(upper<1,upper,1)]
medians12[, time := 2012]
medians <- rbind(medians12,medians18)
medians[, time := factor(time)]
rhfs12[, time := 2012]
rhfs18[, time := 2018]
rhfs_points <- rbind(rhfs12,rhfs18,fill=T)
rhfs_points[, time := factor(time)]
png(paste0(plot_dir,'/Figure0_2012_2018.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_point(data=rhfs_points[!is.na(rent_exploitation)],
             aes(x=market_value_unit_decile2,
                 y=rent_exploitation,
                 fill=time,
                 group=time),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile2,
                     ymin=lower,
                     ymax=upper,
                     color=time,
                     group=time),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile2,
                 y=median,
                 fill=time,
                 group=time),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Median rent exploitation (rent per unit / market value per unit)'),x='Market value per unit decile',fill='RHFS\nsample') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5','6','7','8','9','10\n(highest)')) +
  lims(y=c(0,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

## FIGURE 1
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
table(rhfs18[,c('market_value_unit_decile','units_total_cat')])
prop.table(svytable(~market_value_unit_decile+units_total_cat, des))
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_unit_decile+units_total_cat', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
png(paste0(plot_dir,'/Figure1_exploit_value_size.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_point(data=rhfs18,
             aes(x=market_value_unit_decile,
                 y=rent_exploitation,
                 fill=units_total_cat,
                 group=units_total_cat),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=units_total_cat,
                     group=units_total_cat),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=units_total_cat,
                 group=units_total_cat),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Median rent exploitation (rent per unit / market value per unit)'),x='Market value per unit quintile',fill='Total units') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(0,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()
table(rhfs18[,c('market_value_unit_decile','ownership')])
prop.table(svytable(~market_value_unit_decile+ownership, des))
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_unit_decile+ownership', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
png(paste0(plot_dir,'/Figure2_exploit_value_own.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_point(data=rhfs18,
             aes(x=market_value_unit_decile,
                 y=rent_exploitation,
                 fill=ownership,
                 group=ownership),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=ownership,
                     group=ownership),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=ownership,
                 group=ownership),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Median rent exploitation per unit (rent / market value)'),x='Market value per unit quintile',fill='Ownership') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(0,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(profit_unit_month_margin),])
table(rhfs18[,c('market_value_unit_decile','units_total_cat')])
prop.table(svytable(~market_value_unit_decile+units_total_cat, des))
medians <- calc_svymetric(des, svyvar='profit_unit_month_margin', byvar='market_value_unit_decile+units_total_cat', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
medians[, lower := ifelse(lower>-1,lower,-1)]
png(paste0(plot_dir,'/Figure3_profit_value_size.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_hline(yintercept=0,linetype='dashed') + 
  geom_point(data=rhfs18,
             aes(x=market_value_unit_decile,
                 y=profit_unit_month_margin,
                 fill=units_total_cat,
                 group=units_total_cat),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=units_total_cat,
                     group=units_total_cat),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=units_total_cat,
                 group=units_total_cat),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Profit margin per unit ((rent - expenses) / rent)'),x='Market value per unit quintile',fill='Total units') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(-1,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()
medians <- calc_svymetric(des, svyvar='profit_unit_month_margin', byvar='market_value_unit_decile+ownership', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
medians[, lower := ifelse(lower>-1,lower,-1)]
png(paste0(plot_dir,'/Figure4_profit_value_own.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_hline(yintercept=0,linetype='dashed') + 
  geom_point(data=rhfs18,
             aes(x=market_value_unit_decile,
                 y=profit_unit_month_margin,
                 fill=ownership,
                 group=ownership),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.4)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=ownership,
                     group=ownership),
                 size=1, color='black', position=position_dodge(width=.4)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=ownership,
                 group=ownership),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.4)) + 
  labs(y=paste0('Profit margin per unit ((rent - expenses) / rent)'),x='Market value per unit quintile',fill='Ownership') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(-1,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

## Year acquired and cash down
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_unit_decile+year_acquired_cat', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
png(paste0(plot_dir,'/Figure5_exploit_year.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_point(data=rhfs18[!is.na(year_acquired_cat)],
             aes(x=market_value_unit_decile,
                 y=rent_exploitation,
                 fill=year_acquired_cat,
                 group=year_acquired_cat),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=year_acquired_cat,
                     group=year_acquired_cat),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=year_acquired_cat,
                 group=year_acquired_cat),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Median rent exploitation per unit (rent / market value)'),x='Market value per unit quintile',fill='Ownership') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(0,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(profit_unit_month_margin),])
medians <- calc_svymetric(des, svyvar='profit_unit_month_margin', byvar='market_value_unit_decile+year_acquired_cat', metric='median')
medians[, upper := ifelse(upper<1,upper,1)]
medians[, lower := ifelse(lower>-1,lower,-1)]
png(paste0(plot_dir,'/Figure6_profit_year.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_hline(yintercept=0,linetype='dashed') + 
  geom_point(data=rhfs18[!is.na(year_acquired_cat)],
             aes(x=market_value_unit_decile,
                 y=profit_unit_month_margin,
                 fill=year_acquired_cat,
                 group=year_acquired_cat),
             shape=21, size=3, fill=NA, alpha=0.1, position=position_dodge(width=.6)) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=year_acquired_cat,
                     group=year_acquired_cat),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=year_acquired_cat,
                 group=year_acquired_cat),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Profit margin per unit ((rent - expenses) / rent)'),x='Market value per unit quintile',fill='Ownership') +
  guides(color=F) + 
  scale_fill_viridis_d() + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(-1,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

## Ownership composition
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation)])
calc_svymetric(des, svyvar='rent_exploitation', byvar='ownership', metric='median')
d1 <- as.data.table(prop.table(svytable(~ownership, des)))
d1[, table := 'Ownership\n(all rental units)']
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[market_value_unit_decile==1,])
d2 <- as.data.table(prop.table(svytable(~ownership, des)))
d2[, table := 'Ownership\n(all units in lowest market value quintile)']
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[year_acquired_cat=='Post-2010' & market_value_unit_decile==1,])
d3 <- as.data.table(prop.table(svytable(~ownership, des)))
d3[, table := 'Ownership\n(all units in lowest quintile acquired after 2010)']
own_table <- rbindlist(list(d3,d2,d1))
own_table[, table := factor(table,levels=c('Ownership\n(all rental units)','Ownership\n(all units in lowest market value quintile)','Ownership\n(all units in lowest quintile acquired after 2010)'))]
own_table[, ownership := factor(ownership, levels=c('Individual','LLC','Corporation/REIT','Other'))]
png(paste0(plot_dir,'/Owner_composition.png'), res=600, units='in', height=9, width=16)
ggplot() +
  geom_bar(data=own_table[N!=0,],
           aes(x=ownership,
               y=N,
               fill=ownership),
           stat='identity',color='black') +
  scale_fill_viridis_d(guide=F) +
  facet_wrap(~table) + 
  labs(x='Ownership',y='Proportion') + 
  theme_bw() + 
  theme(strip.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

rhfs18[, ownership := factor(ownership, levels=c('Individual','LLC','Corporation/REIT','Other'))]
summary(lm(rent_exploitation ~ ownership, weight=weight*units_total_topcode, data=rhfs18))
summary(lm(rent_exploitation ~ ownership + ownership*scale(market_value) + ownership*scale(units_total_topcode), weight=weight*units_total_topcode, data=rhfs18))


# own_table <- as.data.table(prop.table(svytable(~cash_down_cat+year_acquired_cat+ownership, des)))
# own_table <- own_table[N!=0,]
# own_table[, year_total := sum(N), by='year_acquired_cat']
# own_table[, year_prop := N / year_total]
# own_table[, year_acquired_cat := factor(year_acquired_cat,levels=c('Pre-1990','1990-2009','Post-2010'))]
# own_table[, year_acquired_num := as.numeric(year_acquired_cat)]
# own_table[, cash_down_cat := factor(cash_down_cat,levels=c('0%','1-24%','25-79%','>80%'))]
# ggplot(data=own_table,
#        aes(x=year_acquired_num,
#            y=year_prop)) + 
#   geom_line(aes(group=ownership)) + 
#   geom_point(aes(fill=ownership),shape=21,size=6) +
#   scale_fill_viridis_d(name='Ownership') + 
#   scale_x_continuous(breaks=c(1,2,3),labels=c('Pre-1990','1990-2009','Post-2010')) +
#   labs(x='Year acquired',y='Proportion of total rental units in period') + 
#   facet_wrap(~cash_down_cat,nrow=1) + 
#   theme_bw()
ggplot() + 
  geom_bar(data=own_table,
           aes(x=))

## Diagnostics
rhfs18[, topcode_taxes := ifelse(property_taxes=='17500+','top','no_top')]
table(rhfs18[,c('market_value_unit_decile','topcode_taxes')])

## Test PLACES parcels in Boston
# library(sf)
# library(tigris)
# parcels_st <- st_read("C:/Users/ncgra/Downloads/25017_pc_polygon.gpkg")
# parcels <- fread("C:/Users/ncgra/Downloads/25017_pc.csv")
# parcels[, owner_n := .N, by='owner']
# unique(parcels[owner_n>100, owner])

## Test EXCESS RENT from Census/ACS in Philly
income <- get_acs(geography='tract', state='PA', county='101', table='B25119', year=2019)
income <- as.data.table(income)
income <- income[variable=='B25119_003']
setnames(income, 'estimate', 'median_income')
rent <- get_acs(geography='tract', state='PA', county='101', table='DP04', year=2019)
rent <- as.data.table(rent)
rent <- rent[variable=='DP04_0134']
setnames(rent, 'estimate', 'median_rent')
rent <- merge(rent, income, by='GEOID')
rent[, target_rent := (median_income * 0.3) / 12]
rent[, excess_rent := median_rent - target_rent]
tracts <- tracts(class='sf',state='PA',county='101')
tracts <- merge(tracts, rent, by='GEOID')
ggplot() + 
  geom_sf(data=tracts,aes(fill=excess_rent)) + 
  scale_fill_viridis_c(name='Excess rent')
mapplot1 <- make_map(user_shapefile = tracts,
                     vars = c('excess_rent'),
                     custom_breaks = list('excess_rent'=c(0,500)), 
                     clean_var_names = data.table(raw=c('excess_rent'),
                                                  clean=c('Excess rent')))
poverty <- get_acs(geography='tract', state='PA', county='101', table='S1702', year=2019)
poverty <- as.data.table(poverty)
poverty <- poverty[variable=='S1702_C02_001',]
poverty <- poverty[, fam_pov_quintile := cut(estimate, quantile(estimate, probs=0:5/5, na.rm=T), include.lowest=TRUE, labels=FALSE)]
poverty[, fam_pov_quintile := factor(fam_pov_quintile,levels=1:5)]
test <- as.data.table(tracts)
test <- merge(test, poverty[,c('GEOID','fam_pov_quintile')], by='GEOID')
test <- test[, list(median_excess_rent=median(excess_rent,na.rm=T)), by='fam_pov_quintile']
test <- test[!is.na(median_excess_rent)]

## Test REGRID block-level rent exploitation in Philly
library(sf)
library(geojson)
library(geojsonio)
library(geojsonsf)
library(tidycensus)
library(tigris)
library(data.table)
library(survey)
Sys.setenv(CENSUS_API_KEY='ecae108da10a8741591e6bdda9aee2c1cb438538')

## Check REGRID counties that have market value, number of units, and strandardized structure code (multifamily residential)
library(tigris)
regrid <- fread("C:/Users/ncgra/Dropbox/Eviction Lab/project ideas/rent_exploitation/Regrid Coverage Report.csv")
target_geoids <- regrid[parval_pct>=80 & numunits_pct>=80 & lbcs_structure_pct>=80 & owner_pct>=80, geoid]
all_counties <- counties(class='sf')
all_counties <- as.data.table(all_counties)
all_counties[, geoid := as.numeric(GEOID)]
all_counties <- all_counties[geoid %in% target_geoids,]
units <- get_acs(geography='county',year=2019,table='B25003')
units <- as.data.table(units)
units <- units[variable=='B25003_003']
setnames(units, 'estimate', 'rental_units')
all_counties <- merge(all_counties, units, by='GEOID')
all_counties <- all_counties[, c('NAME.y','rental_units')]
all_counties <- all_counties[order(-rental_units)]
write.csv(all_counties, 'C:/Users/ncgra/Dropbox/Eviction Lab/project ideas/rent_exploitation/Regrid_target_counties.csv', row.names = F)
## TARGET COUNTIES TO TEST: St Louis (St Louis county, St Louis city), Houston (Harris county), Memphis (Shelby County)

## Tract-level: median rent per unit from ACS / (total market value of multifamily buildings from Regrid / total multifamily rental units from ACS)
get_exploitation <- function(this_city) {
this_county <- cities[city==this_city, fips]
city <- this_city
message(city)
message(this_county)
## REGRID BLOCKGROUP-LEVEL
## COLLAPSE MARKET VALUE BY BUILDING SIZE OF MULTIFAMILY RESIDENTIAL STRUCTURES
#philly <- geojson_sf(paste0("W:/Affordable/Data/Regrid/",city,".json"))
philly <- geojson_sf(paste0('C:/users/ncgra/Documents/regrid_files/',city,'.geojson/',city,'.json'))
philly_multifamily <- philly[philly$lbcs_structure %in% 1200:1299,]
philly_multifamily <- as.data.table(philly_multifamily)
philly_multifamily[numunits %in% 2:4, units := '2 to 4']
philly_multifamily[numunits %in% 5:19, units := '5 to 19']
philly_multifamily[numunits %in% 20:49, units := '20 to 49']
philly_multifamily[numunits >= 50, units := '50 or more']
#philly_multifamily <- philly_multifamily[, list(regrid_total_value=sum(as.numeric(parval),na.rm=T),regrid_rental_units=sum(as.numeric(numunits),na.rm=T)), by=c('census_blockgroup','units')]
philly_multifamily <- philly_multifamily[, c('census_blockgroup','units','parval','numunits')]
philly_multifamily[, parval := as.numeric(parval)]
philly_multifamily[, numunits := as.numeric(numunits)]
setnames(philly_multifamily, 'census_blockgroup', 'GEOID')
## ACS BLOCKGROUP-LEVEL: rent per unit by building size (combine with Regrid where we know number of units and market value)
## GET GROSS RENT BY STRUCTURE FOR BLOCK GROUPS
rent_geography <- 'block group'
#rent_geography <- 'tract'
rent <- get_acs(geography=rent_geography,year=2019,state=substr(this_county,1,2),county=substr(this_county,3,5),table='B25066')
rent <- as.data.table(rent)
rent_vars <- vars[grepl('^B25066_',name),]
rent <- merge(rent, rent_vars, by.x='variable', by.y='name')
rent <- rent[variable %in% paste0('B25066_00',3:6)]
for(size in c('2 to 4','5 to 19','20 to 49','50 or more')) rent[grepl(size,label), units := size]
setnames(rent, 'estimate', 'gross_rent') 
rent <- rent[, c('GEOID','gross_rent','units')]
## GET HOUSING UNITS BY STRUCTURE FOR BLOCK GROUPS
units <- get_acs(geography=rent_geography,year=2019,state=substr(this_county,1,2),county=substr(this_county,3,5),table='B25032')
units <- as.data.table(units)
rent_vars <- vars[grepl('^B25032_',name),]
units <- merge(units, rent_vars, by.x='variable', by.y='name')
units <- units[variable %in% paste0('B25032_0',16:21), ]
for(size in c('2|3 or 4','5 to 9|10 to 19','20 to 49','50 or more')) units[grepl(size,label), units := size]
units[grepl('3 or 4',units), units := '2 to 4']
units[grepl('10 to 19',units), units := '5 to 19']
units <- units[, list(rental_units=sum(estimate)), by=c('GEOID','units')]
## Merge to calculate rent per unit by building size (block-group)
all <- merge(rent, units, by=c('GEOID','units'))
all <- all[rental_units!=0 & !is.na(gross_rent)]
all[, rent_per_unit := gross_rent / rental_units]
## MERGE REGRID AND ACS, COMPARE UNITS
all <- merge(all, philly_multifamily, by=c('GEOID','units'))
all[, city := city]
saveRDS(all, paste0('C:/Users/ncgra/Dropbox/Eviction Lab/project ideas/rent_exploitation/data/',city,'.RDS'))
return(all)
}
vars <- load_variables(year=2019,dataset='acs5')
vars <- as.data.table(vars)
cities <- list.dirs('C:/Users/ncgra/Documents/regrid_files', full.names = F)
cities <- cities[grepl('geojson',cities)]
cities <- gsub('[.]geojson','',cities)
cities <- data.table(city=c("fl_miami-dade","ga_fulton","md_baltimore-county","mo_st-louis","mo_st-louis-county","ny_queens","ok_tulsa","tn_shelby","tx_harris","ut_salt-lake","ca_alameda"),
                     fips=c("12086","13121","24005","29510","29189","36081","40143","47157","48201","49035","06001"))
all <- rbindlist(lapply(unique(cities[,city]), get_exploitation))
## Read all cities
all <- rbindlist(lapply(cities[,city], function(city) readRDS(paste0('C:/Users/ncgra/Dropbox/Eviction Lab/project ideas/rent_exploitation/data/',city,'.RDS'))))
all[grepl('louis',city), city := 'st_louis']
## Some cities too few block groups and buildings
all <- all[!(city %in% c('md_baltimore-county'))]
all <- all[!is.na(parval) & !is.na(numunits),]
## Make metrics (NEED TO DE-DUPLICATE PARCELS)
#all[, market_value_per_unit := regrid_total_value / regrid_rental_units] 
all[, market_value_per_unit := parval / numunits] 
all[, rent_exploitation := (rent_per_unit*12) / market_value_per_unit]
all <- all[parval!=0,]
table(all[, city])
## Test different ways of calculating market value per unit (are Regrid units underestimate?) and exploitation
## Use national market value quintiles from RHFS 2018
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
national_quintiles <- svyquantile(~market_value_unit, des, quantiles=0:5/5, keep.var=FALSE, include.lowest=T, ci=T, interval.type="Wald")  
national_quintiles <- national_quintiles$quantiles
for(q in 6:2) all[market_value_per_unit<=national_quintiles[,q], market_value_quintile := q-1]
for(q in 6:2) rhfs18[market_value_unit<=national_quintiles[,q], market_value_quintile := q-1]
des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation),])
national_exploitation <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_quintile', metric='median')
all[is.na(market_value_quintile), market_value_quintile := 5]
all[, weight := 1]
all[, sample_size := .N, by=c('city','market_value_quintile')]
des <- svydesign(id=~GEOID, weights=~rental_units, data=all[!is.na(rent_exploitation) & sample_size != 1,])
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='market_value_quintile+city', metric='median')
#medians[, market_value_quintile := factor(market_value_quintile, levels=1:5)]
rent_labs <- calc_svymetric(des, svyvar='rent_per_unit', byvar='market_value_quintile+city', metric='median')
value_labs <- calc_svymetric(des, svyvar='market_value_per_unit', byvar='market_value_quintile+city', metric='median')
all_labs <- merge(rent_labs, value_labs, by=c('market_value_quintile','city'))
all_labs[, quintile_label := paste0('Rent=$',round(median.x),', Value=$',round(median.y/1000),'k')]
medians <- merge(medians, all_labs[,c('market_value_quintile','city','quintile_label')], by=c('market_value_quintile','city'))
all[, total_properties := .N, by=c('city')]
all <- merge(all, data.table(city=c("fl_miami-dade","ga_fulton","md_baltimore-county","st_louis","ny_queens","ok_tulsa","tn_shelby","tx_harris","ut_salt-lake","ca_alameda"),
                                     city_clean=c("Miami-Dade, FL","Fulton, GA","Baltimore, MD","St Louis (city and county), MO","Queens, NY","Tulsa, OK","Shelby, TN","Harris, TX","Salt Lake, UT","Alameda, CA")), by='city')
all[, city_facet := paste0(city_clean, '\n(N=',total_properties,')')]
medians <- merge(medians, unique(all[,c('city','city_facet')]), by='city')
png(paste0(plot_dir,'/Regrid_exploitation.png'), res=600, units='in', height=11, width=9)
ggplot(data=medians) + 
  geom_ribbon(data=national_exploitation,
              aes(x=market_value_quintile,
                  ymax=upper,ymin=lower),alpha=0.5,color=NA,fill='grey') + 
  geom_line(data=national_exploitation,
            aes(x=market_value_quintile,
                y=median),linetype='dashed',size=1) + 
  geom_line(aes(x=market_value_quintile,
                y=median,
                color=city),size=1) + 
  geom_linerange(aes(x=market_value_quintile,
                     ymin=lower,
                     ymax=upper,
                     color=city,
                     group=city),
                 size=1, color='black') +
  geom_point(aes(x=market_value_quintile,
                 y=median,
                 fill=city,
                 group=city),
             shape=21,
             size=6, stroke=1.5) + 
  geom_label(data=medians[market_value_quintile==1,],
             aes(x=market_value_quintile,
                 y=median,
                 label=quintile_label),
             size=3,nudge_x=1.2,nudge_y=0.1) + 
  labs(y=paste0('Median rent exploitation (rent per unit / market value per unit)'),x='Market value per unit quintile',fill='County') +
  guides(color=F) + 
  scale_color_viridis_d(guide='none') + 
  scale_fill_viridis_d(guide='none') + 
  scale_x_continuous(breaks=1:5) +
  lims(y=c(0,1.5)) + 
  facet_wrap(~city_facet) +
  theme_bw() +
  theme(strip.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

## BY PERCENT BLACK
all_metros <- core_based_statistical_areas(class='sf')
county_sf <- counties(class='sf')
county_sf <- county_sf[county_sf$GEOID %in% cities[,fips],]
metros <- st_intersection(all_metros, county_sf) 
metros$area <- as.numeric(st_area(metros))
metros <- as.data.table(metros)
metros <- metros[area!=0,]
metro_tracts <- function(metro_name) {
  st <- states(cb = TRUE)
  cb <- core_based_statistical_areas(cb = TRUE)
  metro <- filter(cb, grepl(metro_name, NAME))
  stcodes <- st[metro,]$STATEFP
  if (length(stcodes) > 1) {
    tr <- rbind_tigris(
      map(stcodes, function(x) {
        tracts(x, cb = TRUE)
      })
    )
  } else {
    tr <- tracts(stcodes, cb = TRUE)
  }
  within <- st_within(tr, metro)
  within_lgl <- map_lgl(within, function(x) {
    if (length(x) == 1) {
      return(TRUE)
    } else {
      return(FALSE)
    }
  })
  output <- tr[within_lgl,]
  ## Add percent Black, percent white
  pop <- rbindlist(lapply(stcodes, function(s) get_acs(geography='tract',year=2019,state=s,table='B02001')))
  pop <- as.data.table(pop)
  pop <- pop[variable %in% c('B02001_001','B02001_002','B02001_003'),]
  pop <- dcast(pop, GEOID ~ variable, value.var='estimate')
  setnames(pop, c('GEOID','total','white','black'))
  pop[, b := black / sum(black)]
  pop[, w := white / sum(white)]
  index <- sum(pop[, abs(b-w)]) / 2
  ## Calculate index of dissimilarity across metro
  return(data.table(metro_name=metro_name,index=index))
}
index <- rbindlist(lapply(metros[,NAME], metro_tracts))
index[, fips := paste0(metros$STATEFP,metros$COUNTYFP)]
get_percent_black <- function(this_county) {
  black <- get_acs(geography='block group',year=2019,state=substr(this_county,1,2),county=substr(this_county,3,5),table='B02001')
  black <- as.data.table(black)
  black <- black[variable %in% c('B02001_001','B02001_003'),]
  black <- dcast(black, GEOID ~ variable, value.var='estimate')
  black[, percent_black := B02001_003 / B02001_001]
  return(black)
}
black <- rbindlist(lapply(cities[,fips], get_percent_black))
all <- merge(all, black, by='GEOID', all.x=T)
national_quintiles_black <- seq(0,1,.2)
for(q in 6:2) all[percent_black<=national_quintiles_black[q], percent_black_quintile := q-1]
des <- svydesign(id=~GEOID, weights=~rental_units, data=all[!is.na(rent_exploitation) & sample_size != 1,])
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='city+percent_black_quintile', metric='median')
medians <- calc_svymetric(des, svyvar='rent_exploitation', byvar='percent_black_quintile+city', metric='median')
rent_labs <- calc_svymetric(des, svyvar='rent_per_unit', byvar='percent_black_quintile+city', metric='median')
value_labs <- calc_svymetric(des, svyvar='market_value_per_unit', byvar='percent_black_quintile+city', metric='median')
all_labs <- merge(rent_labs, value_labs, by=c('percent_black_quintile','city'))
all_labs[, quintile_label_black := paste0('Rent=$',round(median.x),', Value=$',round(median.y/1000),'k')]
medians <- merge(medians, all_labs[,c('percent_black_quintile','city','quintile_label_black')], by=c('percent_black_quintile','city'))
medians <- merge(medians, unique(all[,c('city','city_facet')]), by='city')
#png(paste0(plot_dir,'/Regrid_exploitation.png'), res=600, units='in', height=11, width=9)
ggplot(data=medians) + 
  geom_line(aes(x=percent_black_quintile,
                y=median,
                color=city),size=1) + 
  geom_linerange(aes(x=percent_black_quintile,
                     ymin=lower,
                     ymax=upper,
                     color=city,
                     group=city),
                 size=1, color='black') +
  geom_point(aes(x=percent_black_quintile,
                 y=median,
                 fill=city,
                 group=city),
             shape=21,
             size=6, stroke=1.5) + 
  geom_label(data=medians[percent_black_quintile==1,],
             aes(x=percent_black_quintile,
                 y=median,
                 label=quintile_label_black),
             size=3,nudge_x=1.2,nudge_y=0.1) + 
  labs(y=paste0('Median rent exploitation (rent per unit / market value per unit)'),x='Market value per unit quintile',fill='County') +
  guides(color=F) + 
  scale_color_viridis_d(guide='none') + 
  scale_fill_viridis_d(guide='none') + 
  scale_x_continuous(breaks=1:5) +
  #lims(y=c(0,1.5)) + 
  facet_wrap(~city_facet) +
  theme_bw() +
  theme(strip.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
#dev.off()
ggplot(data=all[market_value_per_unit<135200,],
       aes(x=market_value_per_unit ,
           y=rent_per_unit  )) + 
  geom_point() +
  geom_smooth() + 
  geom_abline(slope=0.1,color='red',size=2) + ## 10-year recover building value
  theme_minimal()
## REGRESSION
all <- merge(all, data.table(city=c("fl_miami-dade","ga_fulton","md_baltimore-county","st_louis","ny_queens","ok_tulsa","tn_shelby","tx_harris","ut_salt-lake","ca_alameda"),
                             metro_name=c("Miami-Fort Lauderdale-Pompano Beach, FL","Atlanta-Sandy Springs-Alpharetta, GA","Baltimore-Columbia-Towson, MD",
                                          "St. Louis, MO-IL","New York-Newark-Jersey City, NY-NJ-PA","Tulsa, OK","Memphis, TN-MS-AR","Houston-The Woodlands-Sugar Land, TX",
                                          "Salt Lake City, UT","San Francisco-Oakland-Berkeley, CA")), by='city')
all <- merge(all, unique(index[,c('metro_name','index')]), by='metro_name')
all[, percent_black := percent_black * 100]
m <- lm(rent_exploitation ~ percent_black*index, data=all)
library(interplot)
interplot(m,'percent_black','index')
library(mgcv)
mod_gam1 <- gam(rent_exploitation ~ s(percent_black, bs="cr"), data=all)
plot(mod_gam1)
all[, majorblack := ifelse(percent_black>70,1,0)]
test <- all[,list(exploitation=median(rent_exploitation,na.rm=T)),by=c('metro_name','majorblack','index')]
test[order(index,majorblack)]
ggplot(data=test,aes(x=index,y=exploitation,fill=as.factor(majorblack))) + 
  geom_line() + 
  geom_point(shape=21,color='black',size=4) + 
  scale_fill_viridis_d() + 
  theme_bw()

## Examine distributions of rent per unit and market value per unit in each city compared to RHFS 2018
agg <- all[, list(market_value_per_unit=weighted.mean(market_value_per_unit,rental_units),
                  rent_per_unit=weighted.mean(rent_per_unit,rental_units)),
           by=c('market_value_quintile','city')]
hist(agg[market_value_quintile==1, rent_per_unit])

des <- svydesign(id=~rhfs_2018_hid, weights=~weight*units_total_topcode, strata=~units_total_cat, data=rhfs18[!is.na(rent_exploitation)])
medians <- calc_svymetric(des, svyvar='rent_per_unit', byvar='market_value_unit_decile', metric='median')
## Make map of St Louis (parcels summed to block group, size = units, fill = exploitation)
stlouis <- all[city=='ca_alameda', list(units=sum(numunits),rent_exploitation=weighted.mean(rent_exploitation,numunits)), by='GEOID']
#bgs <- rbind(block_groups(class='sf',state='29',county='189'), block_groups(class='sf',state='29',county='501'))
bgs <- block_groups(class='sf',state='06',county='001')
bgs <- merge(bgs, stlouis, by='GEOID', all.x=T)
bgscenter <- st_centroid(bgs)
bgscenter <- as.data.table(bgscenter)
bgscenter[, long := tstrsplit(geometry,' ',keep=1)]
bgscenter[, lat := tstrsplit(geometry,' ',keep=2)]
bgscenter[, lat := gsub('c|[(]|[)]|,','',lat)]
bgscenter[, long := gsub('c|[(]|[)]|,','',long)]
bgscenter[, long := as.numeric(long)]
bgscenter[, lat := as.numeric(lat)]
bgscenter[rent_exploitation>1, rent_exploitation := 1]
ggplot() + 
  geom_sf(data=bgs,fill=NA) + 
  geom_point(data=bgscenter[!is.na(rent_exploitation)],
             aes(y=lat,x=long,fill=rent_exploitation,size=units),shape=21) + 
  scale_size_area(max_size = 15) + 
  scale_fill_viridis_c() + 
  theme_minimal()




#cities <- c('az_maricopa','tx_dallas','fl_duval')
#all_counties <- c('04013','48113','12031')
vars <- load_variables(year=2019,dataset='acs5')
vars <- as.data.table(vars)
cities <- c('tn_shelby')
all_counties <- c('47157')
medians <- rbindlist(lapply(1:3, get_exploitation))
#medians[, upper := ifelse(upper<1,upper,1)]
#medians[, median := ifelse(median<1,median,1)]
## Create value per unit quintiles using RHFS 2018 national percentiles
medians <- rbindlist(lapply(cities, function(city) readRDS(paste0('C:/Users/ncgra/Documents/regrid/',city,'_all.RDS'))))

png(paste0(plot_dir,'/Regrid_exploitation.png'), res=600, units='in', height=9, width=11)
ggplot(data=medians) + 
  geom_linerange(aes(x=market_value_unit_decile,
                     ymin=lower,
                     ymax=upper,
                     color=city,
                     group=city),
                 size=1, color='black', position=position_dodge(width=.6)) +
  geom_point(aes(x=market_value_unit_decile,
                 y=median,
                 fill=city,
                 group=city),
             shape=21,
             size=6, stroke=1.5, position=position_dodge(width=.6)) + 
  labs(y=paste0('Median rent exploitation (rent per unit / market value per unit)'),x='Market value per unit quintile',fill='County') +
  guides(color=F) + 
  scale_fill_viridis_d(labels=c('Phoenix','Jacksonville','Dallas')) + 
  scale_x_discrete(labels=c('1\n(lowest)','2','3','4','5\n(highest)')) +
  lims(y=c(0,1)) + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 18, margin = margin(r=10)),
        axis.title.x = element_text(size = 18, margin = margin(t=10)),
        axis.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
dev.off()

parcels <- read_sf("C:/Users/ncgra/Downloads/DOR_Parcel/DOR_Parcel.shp")
parcels <- geojson_sf("C:/Users/ncgra/Downloads/opa_properties_public.geojson")
summary(parcels$market_value)

## Assign parcels to tracts by centroid
parcel_centroids <- st_centroid(parcels)
parcel_centroids <- st_transform(parcel_centroids, st_crs(philly_tracts))
overlaps <- st_intersection(parcel_centroids, philly_tracts)
## Sum market values by tract
